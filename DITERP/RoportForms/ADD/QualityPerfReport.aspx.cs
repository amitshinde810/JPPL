using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Data;
using CrystalDecisions.CrystalReports.Engine;

public partial class Masters_ADD_QualityPerfReport : System.Web.UI.Page
{
    DatabaseAccessLayer DL_DBAccess = null;

    protected void Page_Load(object sender, EventArgs e)
    {
        HtmlGenericControl home = (HtmlGenericControl)this.Page.Master.FindControl("Menus").FindControl("Purchase");
        home.Attributes["class"] = "active";
        HtmlGenericControl home1 = (HtmlGenericControl)this.Page.Master.FindControl("Menus").FindControl("Purchase1MV");
        home1.Attributes["class"] = "active";
    }

    #region Page_Init
    protected void Page_Init(object sender, EventArgs e)
    {
        try
        {
            string Title = Request.QueryString[0];
            string From = Request.QueryString[1].ToString();
            string str = Request.QueryString[2].ToString();
            string Cond = Request.QueryString[3].ToString();
            ViewState["str"] = str;
            GenerateReport(Title, From, str, Cond);
        }
        catch (Exception Ex)
        {
        }
    }
    #endregion

    #region GenerateReport
    private void GenerateReport(string Title, string From, string str, string Cond)
    {
        try
        {
            DataTable dtmaster = new DataTable();
            double DeliveryPer = 0.0, QualityPer = 0.0, AuditPer = 0.0, PremiumPer = 0.0, CustomerPer = 0.0;

            DL_DBAccess = new DatabaseAccessLayer();
            string Query = "";
            DateTime dtMonth = Convert.ToDateTime(From);
            /*For Quality Performance Monitering Sheet*/
            #region QualityPerf
            if (str == "QualityPerf")
            {
                lblTitle.Text = "Quality Performance Monitoring Sheet";
                Page.Title = "Quality Performance Monitoring Sheet";
                /*Perf:- IWD_CON_REJ_QTY/IWD_CON_OK_QTY*/
                //Query = "SELECT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,isnull(IWD_REV_QTY,0) as IWD_REV_QTY,ISNULL(IWD.IWD_CON_OK_QTY,0) as IWD_CON_OK_QTY,isnull(IWD.IWD_CON_REJ_QTY,0) as IWD_CON_REJ_QTY,SPOM.SPOM_PONO,IWD.IWD_INSP_NO,IWM.IWM_TYPE,case when ISNULL(IWD.IWD_REV_QTY,0)=0 then 0 else round( ISNULL((isnull(IWD.IWD_CON_OK_QTY,0)/ISNULL(IWD.IWD_REV_QTY,0))*100,0),2) end as Perf FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE WHERE " + Cond + " datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND(IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 ORDER BY P.P_CODE";
                //Query = "SELECT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM.SPOM_PONO,IWM.IWM_TYPE,isnull(sum(IWD_REV_QTY),0) as IWD_REV_QTY,ISNULL(sum(IWD.IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,isnull(sum(IWD.IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,case when ISNULL(sum(IWD.IWD_CON_OK_QTY),0)=0 then 0 else round( ISNULL((isnull(sum(IWD.IWD_CON_REJ_QTY),0)/ISNULL(sum(IWD.IWD_CON_OK_QTY),0))*100,0),2) end as Perf FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE WHERE " + Cond + " datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND(IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND='1' and P_ACTIVE_IND='1' group by P.P_CODE,P.P_NAME,P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM_PONO,IWM_TYPE ORDER BY Perf DESC,P_NAME asc";
                //Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE inner join SUPP_PO_MASTER SPOM on IWD_CPOM_CODE=SPOM_CODE WHERE SPOM.ES_DELETE=0 AND INWARD_MASTER.ES_DELETE=0 AND IWD_I_CODE=PSD.PSD_I_CODE and IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_CON_REJ_QTY from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'";
                //Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'";
                /*Change Query :- For Vendor Add R4A + R5 Rejection From IRN Module (Mahining Rejection) Vendor wise...*/
                Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483645 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE),0) AS R4A,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483643 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE ),0) AS R5,ISNULL((SELECT distinct ISNULL(IWM_TYPE,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) as SuppType into #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,P_VEND_CODE,PSD_PO_CODE,SPOM_PONO,I_CODE,I_CODENO,I_NAME,Schedule_Qty,IWD_CON_OK_QTY,IWD_REV_QTY,IWD_CON_REJ_QTY as Con,case when SuppType='OUTCUSTINV' then ISNULL((isnull(R4A,0)+isnull(R5,0)),0) else IWD_CON_REJ_QTY end as IWD_CON_REJ_QTY,R4A,R5,SuppType from #Temp order by P_NAME,I_CODENO drop table #Temp";
                DataSet ds = new DataSet();
                DataTable dt = new DataTable();
                dt = CommonClasses.Execute(Query);
                #region Bind_ds_To_Rpt
                if (dt.Rows.Count > 0)
                {
                    ReportDocument rptname = null;
                    rptname = new ReportDocument();

                    rptname.Load(Server.MapPath("~/Reports/QualityPerf.rpt"));
                    rptname.FileName = Server.MapPath("~/Reports/QualityPerf.rpt");
                    rptname.Refresh();
                    rptname.SetDataSource(dt);
                    rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                    rptname.SetParameterValue("txtDate", dtMonth.ToString("MM yyyy"));
                    rptname.SetParameterValue("Title", "Quality Performance Monitoring Sheet");
                    CrystalReportViewer1.ReportSource = rptname;
                }
                else
                {
                    PanelMsg.Visible = true;
                    lblmsg.Text = " No Record Found! ";
                }
                #endregion
            }
            #endregion QualityPerf

            #region OverAllPerf_Supplier_Wise
            else if (str == "Overall")
            {
                dtmaster = CommonClasses.Execute("SELECT * FROM SUPPLIER_AUDIT_SCORE ORDER BY SRNO");
                if (dtmaster.Rows.Count > 0)
                {
                    DeliveryPer = Convert.ToDouble(dtmaster.Rows[0]["Per"].ToString());
                    QualityPer = Convert.ToDouble(dtmaster.Rows[1]["Per"].ToString());
                    AuditPer = Convert.ToDouble(dtmaster.Rows[2]["Per"].ToString());
                    PremiumPer = Convert.ToDouble(dtmaster.Rows[3]["Per"].ToString());
                    CustomerPer = Convert.ToDouble(dtmaster.Rows[4]["Per"].ToString());
                }

                lblTitle.Text = "Overall Performance Of Supplier";
                Page.Title = "Overall Performance Of Supplier";
                /*Perf := Delivery Perf*40 + QualityPerf*40 + SAM_QUALITY + SAM_DELIVERY */
                //Query = "SELECT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM.SPOM_PONO,IWM.IWM_TYPE,isnull(sum(IWD_REV_QTY),0) as IWD_REV_QTY,ISNULL(sum(IWD.IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,isnull(sum(IWD.IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,case when ISNULL(sum(IWD.IWD_REV_QTY),0)=0 then 0 else round( ISNULL((isnull(sum(IWD.IWD_CON_OK_QTY),0)/ISNULL(sum(IWD.IWD_REV_QTY),0))*100,0),2) end as Perf,isnull((SELECT SCM_NAME FROM PARTY_MASTER INNER JOIN SUPPLIER_CATEGORY_MASTER SCM ON P_E_CODE=SCM.SCM_CODE WHERE PARTY_MASTER.P_CODE=P.P_CODE AND PARTY_MASTER.ES_DELETE=0 AND SCM.ES_DELETE=0),'') as Category into #Temp FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE WHERE " + Cond + " datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND(IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND=1 and P_ACTIVE_IND=1 group by P.P_CODE,P.P_NAME,P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM_PONO,IWM_TYPE ORDER BY Perf DESC,P_NAME asc select P_CODE,P_NAME,Category,sum(Perf) as Perf1,count(P_CODE) as Cnt Into #Temp1 from #Temp group by P_CODE,Category,P_NAME select P_CODE,P_NAME,Category,Perf1/Cnt as Perf from #Temp1 order by Perf desc,Category ASC,P_NAME asc drop table #Temp drop table #Temp1";
                //Query = "SELECT P.P_CODE,P.P_NAME,isnull(sum(IWD_REV_QTY),0) as IWD_REV_QTY,ISNULL(sum(IWD.IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,isnull(sum(IWD.IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,case when ISNULL(sum(IWD.IWD_REV_QTY),0)=0 then 0 else round( ISNULL((isnull(sum(IWD.IWD_CON_OK_QTY),0)/ISNULL(sum(IWD.IWD_REV_QTY),0))*100,0),2) end as Perf1,ISNULL((select SUM(ISNULL(PSD1.PSD_W1_QTY,0) + ISNULL(PSD1.PSD_W2_QTY,0)+ ISNULL(PSD1.PSD_W3_QTY,0) + ISNULL(PSD1.PSD_W4_QTY,0)) from PURCHASE_SCHEDULE_MASTER as PSM1 INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD1 ON PSM1.PSM_CODE = PSD1.PSD_PSM_CODE WHERE PSM1.ES_DELETE=0 AND PSM1.PSM_CODE= PSM.PSM_CODE and P.P_CODE =PSM1.PSM_P_CODE ),0) AS Schedule_Qty into #Temp FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE inner join PURCHASE_SCHEDULE_MASTER as PSM on P.P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE WHERE " + Cond + " datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND(IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND='1' and P_ACTIVE_IND='1' AND PSM.ES_DELETE=0 AND PSD.PSD_I_CODE=IWD.IWD_I_CODE AND PSD.PSD_PO_CODE=SPOM.SPOM_CODE group by P.P_CODE,P.P_NAME,PSM_CODE,PSM_P_CODE select P_CODE,P_NAME,IWD_REV_QTY,IWD_CON_OK_QTY,IWD_CON_REJ_QTY	,Perf1,Schedule_Qty,case when IWD_CON_OK_QTY=0 then 0 else (IWD_CON_OK_QTY/Schedule_Qty)*40 end as DeliverPerf,case when IWD_CON_OK_QTY=0 then 0 else isnull((IWD_CON_REJ_QTY/IWD_CON_OK_QTY)*40,0) end as QualityPerf into #Temp1 from #Temp select P_CODE,P_NAME,round(ISNULL((ISNULL(DeliverPerf,0)+ISNULL(QualityPerf,0)+ISNULL((ISNULL(SAM_QUALITY,0)/100*10),0)+ISNULL((ISNULL(SAM_DELIVERY,0)/100*10),0)),0),0) AS Perf,isnull((SELECT SCM_NAME FROM PARTY_MASTER INNER JOIN SUPPLIER_CATEGORY_MASTER SCM ON P_E_CODE=SCM.SCM_CODE WHERE PARTY_MASTER.P_CODE=#Temp1.P_CODE AND PARTY_MASTER.ES_DELETE=0 AND SCM.ES_DELETE=0),'') as Category from #Temp1 inner join SUPPLIER_AUDIT_MASTER on P_CODE=SAM_P_CODE WHERE ES_DELETE=0 ORDER BY Perf desc,P_NAME asc drop table #Temp drop table #Temp1";
                //Query = "SELECT DISTINCT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM.SPOM_PONO,IWM.IWM_TYPE,ISNULL((select ISNULL(sum(IWD1.IWD_REV_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_REV_QTY,ISNULL((select ISNULL(sum(IWD1.IWD_CON_OK_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_OK_QTY,ISNULL((select ISNULL(sum(IWD1.IWD_CON_REJ_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_REJ_QTY,ISNULL((select ISNULL(PSD1.PSD_W1_QTY,0) + ISNULL(PSD1.PSD_W2_QTY,0) + ISNULL(PSD1.PSD_W3_QTY,0) + ISNULL(PSD1.PSD_W4_QTY,0) AS PSD_TOTSCHEDULE_QTY from PURCHASE_SCHEDULE_MASTER as PSM1 INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD1 ON PSM1.PSM_CODE = PSD1.PSD_PSM_CODE WHERE PSM1.ES_DELETE=0 AND PSM1.PSM_CODE= PSM.PSM_CODE and P.P_CODE =PSM1.PSM_P_CODE and PSD1.PSD_I_CODE=I.I_CODE AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'),0) AS Schedule_Qty INTO #Temp FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE inner join PURCHASE_SCHEDULE_MASTER as PSM on P.P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE and PSD.PSD_I_CODE= IWD.IWD_I_CODE WHERE " + Cond + " datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND (IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND='1' and P_ACTIVE_IND='1' AND PSM.ES_DELETE=0 AND PSD.PSD_I_CODE=IWD.IWD_I_CODE AND PSD.PSD_PO_CODE=SPOM.SPOM_CODE group by P.P_CODE,P.P_NAME,P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM_PONO,IWM_TYPE,PSM_CODE,PSM_P_CODE,IWM_CODE,IWD_I_CODE select P_CODE,P_NAME,P_VEND_CODE,I_CODE,I_CODENO,I_NAME	,SPOM_PONO,IWM_TYPE,case when (Schedule_Qty=0 AND IWD_CON_OK_QTY<=Schedule_Qty) then 0 else ((Schedule_Qty-IWD_CON_OK_QTY)/Schedule_Qty)*100 end as IWD_REV_QTY,IWD_CON_OK_QTY,IWD_CON_REJ_QTY	,Schedule_Qty,case when Schedule_Qty=0 then 0 else (IWD_CON_OK_QTY/Schedule_Qty)*100 end as Perf,case when IWD_CON_OK_QTY<=Schedule_Qty then Schedule_Qty-IWD_CON_OK_QTY else 0 end as ShortQty INTO #Temp1 from #Temp SELECT P_CODE,P_NAME,IWM_TYPE,case when SUM(IWD_CON_OK_QTY) =0 then 0 else SUM(IWD_CON_REJ_QTY)/SUM(IWD_CON_OK_QTY)*40 end as QualityPerf,case when SUM(Schedule_Qty)=0 then 0 else (SUM(IWD_CON_OK_QTY)/SUM(Schedule_Qty))*40 END AS Perf1 into #Temp2 FROM #Temp1 GROUP BY P_CODE,P_NAME,IWM_TYPE select P_CODE,P_NAME,IWM_TYPE,ISNULL((QualityPerf+Perf1+(ISNULL(SAM_QUALITY,0)/100)*10 +(ISNULL(SAM_DELIVERY,0)/100)*10),0) AS Perf from #Temp2 inner join SUPPLIER_AUDIT_MASTER on P_CODE=SAM_P_CODE where datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' ORDER BY Perf DESC,P_NAME asc drop table #Temp drop table #Temp1 drop table #Temp2";
                // Query = "SELECT DISTINCT P_CODE,P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,SPOM_PONO,IWD_I_CODE,I_CODENO,I_NAME,SUM(IWD_REV_QTY) AS IWD_REV_QTY,SUM(IWD_CON_OK_QTY) AS IWD_CON_OK_QTY,SUM(IWD_CON_REJ_QTY) AS IWD_CON_REJ_QTY into #Temp FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE INNER JOIN PARTY_MASTER ON IWM_P_CODE = PARTY_MASTER.P_CODE INNER JOIN ITEM_MASTER ON IWD_I_CODE = I_CODE inner join SUPP_PO_MASTER SPOM on IWD_CPOM_CODE=SPOM_CODE WHERE P_CODE='-2147483024' AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND (INWARD_MASTER.ES_DELETE = 0) GROUP BY P_CODE,P_NAME,IWD_I_CODE,I_CODENO,I_NAME,P_VEND_CODE,SPOM_PONO select P_CODE,P_NAME,P_VEND_CODE,case when SUM(PSD_MONTH_QTY) <= SUM(IWD_CON_OK_QTY) then 0 else SUM(IWD_CON_OK_QTY)/ SUM(PSD_MONTH_QTY)*40 end as DeliverPerf,case when SUM(IWD_CON_OK_QTY) <= SUM(IWD_CON_REJ_QTY) then 0 else SUM(IWD_CON_REJ_QTY)/ SUM(IWD_CON_OK_QTY)*40 end as Qualityperf into #Temp1 from #Temp inner join PURCHASE_SCHEDULE_MASTER as PSM on P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE and PSD.PSD_I_CODE= IWD_I_CODE where P_CODE='-2147483024' AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,P_VEND_CODE select #Temp1.P_CODE,#Temp1.P_NAME,ISNULL((#Temp1.DeliverPerf +Qualityperf +ISNULL((SAM_QUALITY)/100*10,0)+ISNULL((SAM_DELIVERY)/100*10,0)),0) AS Perf,SCM_NAME AS Category from #Temp1 inner join PARTY_MASTER on #Temp1.P_CODE=PARTY_MASTER.P_CODE INNER JOIN SUPPLIER_CATEGORY_MASTER SCM ON P_E_CODE=SCM.SCM_CODE INNER JOIN SUPPLIER_AUDIT_MASTER ON #Temp1.P_CODE=SAM_P_CODE WHERE datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' drop table #Temp drop table #Temp1";
                //Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE inner join SUPP_PO_MASTER SPOM on IWD_CPOM_CODE=SPOM_CODE WHERE SPOM.ES_DELETE=0 AND INWARD_MASTER.ES_DELETE=0 AND IWD_I_CODE=PSD.PSD_I_CODE and IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE),0) AS IWD_CON_REJ_QTY from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'";
                // Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,P_E_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY INTO #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,ISNULL(SUM(IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,ISNULL(SUM(IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,ISNULL(SUM(Schedule_Qty),0) as Schedule_Qty,(ISNULL(SAM_QUALITY,0)/100)*10 AS SAM_QUALITY,(ISNULL(SAM_DELIVERY,0)/100)*10 AS SAM_DELIVERY,ISNULL((select isnull(SCM_NAME,'') as SCM_NAME from SUPPLIER_CATEGORY_MASTER where P_E_CODE=SCM_CODE ),'') AS Category,case when ISNULL(SUM(Schedule_Qty),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then 40 when ISNULL(SUM(Schedule_Qty),0)=0 then 0 else ISNULL(SUM(IWD_CON_OK_QTY),0)/ISNULL(SUM(Schedule_Qty),0)*40 end as DeliveryPerf,case when ISNULL(SUM(IWD_CON_REJ_QTY),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then 0 when ISNULL(SUM(IWD_CON_REJ_QTY),0)=0 then 40 else ISNULL(SUM(IWD_CON_REJ_QTY),0)/ISNULL(SUM(IWD_CON_OK_QTY),0)* 40 end as QualityPerf into #Temp1 from #Temp inner join SUPPLIER_AUDIT_MASTER ON P_CODE=SAM_P_CODE and SUPPLIER_AUDIT_MASTER.ES_DELETE=0 AND datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,SAM_QUALITY,SAM_DELIVERY,P_E_CODE select P_CODE,P_NAME,isnull((ISNULL(DeliveryPerf,0)+isnull(QualityPerf,0)+isnull(SAM_DELIVERY,0)+isnull(SAM_QUALITY,0)),0) as Perf,Category from #Temp1 ORDER BY Perf desc,P_NAME drop table #Temp drop table #Temp1";

                // Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,P_E_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY INTO #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,ISNULL(SUM(IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,ISNULL(SUM(IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,ISNULL(SUM(Schedule_Qty),0) as Schedule_Qty,(ISNULL(SAM_QUALITY,0)/100)*10 AS SAM_QUALITY,(ISNULL(SAM_DELIVERY,0)/100)*10 AS SAM_DELIVERY,ISNULL((select isnull(SCM_NAME,'') as SCM_NAME from SUPPLIER_CATEGORY_MASTER where P_E_CODE=SCM_CODE ),'') AS Category,case when ISNULL(SUM(Schedule_Qty),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then 40 when ISNULL(SUM(Schedule_Qty),0)=0 then 0 else ISNULL(SUM(IWD_CON_OK_QTY),0)/ISNULL(SUM(Schedule_Qty),0)*40 end as DeliveryPerf,case when ISNULL(SUM(IWD_CON_REJ_QTY),0)=0 then 0 else (ISNULL(SUM(IWD_CON_REJ_QTY),0)/ISNULL(SUM(IWD_CON_OK_QTY),0))*100 end as QualityPerf into #Temp1 from #Temp inner join SUPPLIER_AUDIT_MASTER ON P_CODE=SAM_P_CODE and SUPPLIER_AUDIT_MASTER.ES_DELETE=0 AND datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,SAM_QUALITY,SAM_DELIVERY,P_E_CODE SELECT P_CODE,	P_NAME,	IWD_CON_OK_QTY,	IWD_CON_REJ_QTY	,Schedule_Qty,	SAM_QUALITY	,SAM_DELIVERY,	Category,	DeliveryPerf,CASE WHEN (QualityPerf >=0 and QualityPerf<=0.5) then 100 when (QualityPerf >0.5 and QualityPerf<=1) then 90 when (QualityPerf >1 and QualityPerf<=1.5) then 75 when(QualityPerf >1.5) then 50 END AS QualityPerf into #temp2 FROM #temp1 select P_CODE,P_NAME,isnull((ISNULL(DeliveryPerf,0)+isnull((QualityPerf*40/100),0)+isnull(SAM_DELIVERY,0)+isnull(SAM_QUALITY,0)),0) as Perf,Category from #Temp2 ORDER BY Perf desc,P_NAME drop table #Temp drop table #Temp1 drop table #temp2";
                /*Change Query :- For Vendor Add R4A + R5 Rejection From IRN Module (Mahining Rejection) Vendor wise...*/

                // Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,P_E_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483645 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE),0) AS R4A,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483643 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE ),0) AS R5,ISNULL((SELECT distinct ISNULL(IWM_TYPE,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) as SuppType INTO #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,P_VEND_CODE,P_E_CODE,PSD_PO_CODE,SPOM_PONO,I_CODE,I_CODENO,I_NAME,Schedule_Qty,IWD_CON_OK_QTY,IWD_REV_QTY,case when SuppType='OUTCUSTINV' then ISNULL((isnull(R4A,0)+isnull(R5,0)),0) else IWD_CON_REJ_QTY end as IWD_CON_REJ_QTY,R4A,R5,SuppType INTO #Temp3 from #Temp select P_CODE,P_NAME,ISNULL(SUM(IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,ISNULL(SUM(IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,ISNULL(SUM(Schedule_Qty),0) as Schedule_Qty,(ISNULL(SAM_QUALITY,0)/100)*5 AS SAM_QUALITY,(ISNULL(SAM_DELIVERY,0)/100)*10 AS SAM_DELIVERY,ISNULL((select isnull(SCM_NAME,'') as SCM_NAME from SUPPLIER_CATEGORY_MASTER where P_E_CODE=SCM_CODE ),'') AS Category,case when ISNULL(SUM(Schedule_Qty),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then 30 when ISNULL(SUM(Schedule_Qty),0)=0 then 0 else ISNULL(SUM(IWD_CON_OK_QTY),0)/ISNULL(SUM(Schedule_Qty),0)*30 end as DeliveryPerf,case when ISNULL(SUM(IWD_CON_REJ_QTY),0)=0 then 0 else (ISNULL(SUM(IWD_CON_REJ_QTY),0)/ISNULL(SUM(IWD_CON_OK_QTY),0))*100 end as QualityPerf,(ISNULL(SAM_COST,0)/100)*15 AS SAM_COST into #Temp1 from #Temp3 inner join SUPPLIER_AUDIT_MASTER ON P_CODE=SAM_P_CODE and SUPPLIER_AUDIT_MASTER.ES_DELETE=0 AND datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,SAM_QUALITY,SAM_DELIVERY,P_E_CODE,SAM_COST SELECT P_CODE,P_NAME,	IWD_CON_OK_QTY,	IWD_CON_REJ_QTY	,Schedule_Qty,	SAM_QUALITY	,SAM_DELIVERY,	Category,DeliveryPerf,SAM_COST,CASE WHEN (QualityPerf >=0 and QualityPerf<=0.5) then 100 when (QualityPerf >0.5 and QualityPerf<=1) then 90 when (QualityPerf >1 and QualityPerf<=1.5) then 75 when(QualityPerf >1.5) then 50 END AS QualityPerf into #temp2 FROM #temp1 select P_CODE,P_NAME,isnull((ISNULL(DeliveryPerf,0)+isnull((QualityPerf*40/100),0)+isnull(SAM_DELIVERY,0)+isnull(SAM_QUALITY,0)+isnull(SAM_COST,0)),0) as Perf,Category from #Temp2 ORDER BY Perf desc,P_NAME drop table #Temp drop table #Temp1 drop table #temp2 drop table #Temp3";
                //Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,P_E_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483645 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE),0) AS R4A,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483643 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE ),0) AS R5,ISNULL((SELECT distinct ISNULL(IWM_TYPE,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) as SuppType INTO #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,P_VEND_CODE,P_E_CODE,PSD_PO_CODE,SPOM_PONO,I_CODE,I_CODENO,I_NAME,Schedule_Qty,IWD_CON_OK_QTY,IWD_REV_QTY,case when SuppType='OUTCUSTINV' then ISNULL((isnull(R4A,0)+isnull(R5,0)),0) else IWD_CON_REJ_QTY end as IWD_CON_REJ_QTY,R4A,R5,SuppType INTO #Temp3 from #Temp select P_CODE,P_NAME,ISNULL(SUM(IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,ISNULL(SUM(IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,ISNULL(SUM(Schedule_Qty),0) as Schedule_Qty,(ISNULL(SAM_QUALITY,0)/100)*" + AuditPer + " AS SAM_QUALITY,(ISNULL(SAM_DELIVERY,0)/100)*" + PremiumPer + " AS SAM_DELIVERY,ISNULL((select isnull(SCM_NAME,'') as SCM_NAME from SUPPLIER_CATEGORY_MASTER where P_E_CODE=SCM_CODE ),'') AS Category,case when ISNULL(SUM(Schedule_Qty),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then " + DeliveryPer + " when ISNULL(SUM(Schedule_Qty),0)=0 then 0 else ISNULL(SUM(IWD_CON_OK_QTY),0)/ISNULL(SUM(Schedule_Qty),0)*" + DeliveryPer + " end as DeliveryPerf,case when ISNULL(SUM(IWD_CON_REJ_QTY),0)=0 then 0 else (ISNULL(SUM(IWD_CON_REJ_QTY),0)/ISNULL(SUM(IWD_CON_OK_QTY),0))*100 end as QualityPerf,(ISNULL(SAM_COST,0)/100)*" + CustomerPer + " AS SAM_COST into #Temp1 from #Temp3 inner join SUPPLIER_AUDIT_MASTER ON P_CODE=SAM_P_CODE and SUPPLIER_AUDIT_MASTER.ES_DELETE=0 AND datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,SAM_QUALITY,SAM_DELIVERY,P_E_CODE,SAM_COST SELECT P_CODE,P_NAME,	IWD_CON_OK_QTY,	IWD_CON_REJ_QTY	,Schedule_Qty,	SAM_QUALITY	,SAM_DELIVERY,	Category,DeliveryPerf,SAM_COST,CASE WHEN (QualityPerf >=0 and QualityPerf<=0.5) then 100 when (QualityPerf >0.5 and QualityPerf<=1) then 90 when (QualityPerf >1 and QualityPerf<=1.5) then 75 when(QualityPerf >1.5) then 50 END AS QualityPerf into #temp2 FROM #temp1 select P_CODE,P_NAME,isnull((ISNULL(DeliveryPerf,0)+isnull((QualityPerf*" + QualityPer + "/100),0)+isnull(SAM_DELIVERY,0)+isnull(SAM_QUALITY,0)+isnull(SAM_COST,0)),0) as Perf,Category from #Temp2 ORDER BY Perf desc,P_NAME drop table #Temp drop table #Temp1 drop table #temp2 drop table #Temp3";
                // 26/12/2018 :- Add new Logic for Delivery Perf and Quality Perf
                
                Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,P_E_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483645 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE),0) AS R4A,ISNULL((SELECT SUM(ISNULL(IRND_REJ_QTY,0)) FROM IRN_ENTRY,IRN_DETAIL where IRN_CODE=IRND_IRN_CODE AND IRN_ENTRY.ES_DELETE=0 AND IRND_RSM_CODE=-2147483643 AND datepart(mm,IRN_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IRN_DATE)='" + dtMonth.ToString("yyyy") + "' AND IRND_I_CODE=I_CODE and IRND_TYPE=1 and IRND_P_CODE=PSM.PSM_P_CODE ),0) AS R5,ISNULL((SELECT distinct ISNULL(IWM_TYPE,'') FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) as SuppType INTO #Temp from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' select P_CODE,P_NAME,P_VEND_CODE,P_E_CODE,PSD_PO_CODE,SPOM_PONO,I_CODE,I_CODENO,I_NAME,Schedule_Qty,IWD_CON_OK_QTY,IWD_REV_QTY,case when SuppType='OUTCUSTINV' then ISNULL((isnull(R4A,0)+isnull(R5,0)),0) else IWD_CON_REJ_QTY end as IWD_CON_REJ_QTY,R4A,R5,SuppType INTO #Temp3 from #Temp select P_CODE,P_NAME,ISNULL(SUM(IWD_CON_OK_QTY),0) as IWD_CON_OK_QTY,ISNULL(SUM(IWD_CON_REJ_QTY),0) as IWD_CON_REJ_QTY,ISNULL(SUM(Schedule_Qty),0) as Schedule_Qty,(ISNULL(SAM_QUALITY,0)/100)*" + AuditPer + " AS SAM_QUALITY,(ISNULL(SAM_DELIVERY,0)/100)*" + PremiumPer + " AS SAM_DELIVERY,ISNULL((select isnull(SCM_NAME,'') as SCM_NAME from SUPPLIER_CATEGORY_MASTER where P_E_CODE=SCM_CODE ),'') AS Category,case when ISNULL(SUM(Schedule_Qty),0)=ISNULL(SUM(IWD_CON_OK_QTY),0) then " + DeliveryPer + " when ISNULL(SUM(Schedule_Qty),0)=0 then 0 else ISNULL(SUM(IWD_CON_OK_QTY),0)/ISNULL(SUM(Schedule_Qty),0)*100 end as DeliveryPerf,case when ISNULL(SUM(IWD_CON_REJ_QTY),0)=0 then 0 else (ISNULL(SUM(IWD_CON_REJ_QTY),0)/ISNULL(SUM(IWD_CON_OK_QTY),0))*100 end as QualityPerf,(ISNULL(SAM_COST,0)/100)*" + CustomerPer + " AS SAM_COST into #Temp1 from #Temp3 inner join SUPPLIER_AUDIT_MASTER ON P_CODE=SAM_P_CODE and SUPPLIER_AUDIT_MASTER.ES_DELETE=0 AND datepart(mm,SAM_FDATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,SAM_FDATE)='" + dtMonth.ToString("yyyy") + "' group by P_CODE,P_NAME,SAM_QUALITY,SAM_DELIVERY,P_E_CODE,SAM_COST SELECT P_CODE,P_NAME,	IWD_CON_OK_QTY,	IWD_CON_REJ_QTY	,Schedule_Qty,	SAM_QUALITY	,SAM_DELIVERY,	Category,CASE WHEN (DeliveryPerf >=95) then 100 when (DeliveryPerf >=90 and DeliveryPerf <95) then 85 when (DeliveryPerf >=80 and DeliveryPerf<90) then 70 when(DeliveryPerf <80) then 0 END AS DeliveryPerf,CASE WHEN (QualityPerf >=0 and QualityPerf<=1) then 100 when (QualityPerf >1 and QualityPerf<=2) then 80 when (QualityPerf >2 and QualityPerf<=3) then 70 when(QualityPerf >3) then 0 END AS QualityPerf,SAM_COST into #temp2 FROM #temp1 select P_CODE,P_NAME,isnull((ISNULL(DeliveryPerf*" + DeliveryPer + "/100,0)+isnull((QualityPerf*" + QualityPer + "/100),0)+isnull(SAM_DELIVERY,0)+isnull(SAM_QUALITY,0)+isnull(SAM_COST,0)),0) as Perf,Category from #Temp2 ORDER BY Perf desc,P_NAME drop table #Temp drop table #Temp1 drop table #temp2 drop table #Temp3";
                DataSet ds = new DataSet();
                DataTable dt = new DataTable();
                dt = CommonClasses.Execute(Query);
                #region Bind_ds_To_Rpt
                if (dt.Rows.Count > 0)
                {
                    ReportDocument rptname = null;
                    rptname = new ReportDocument();

                    rptname.Load(Server.MapPath("~/Reports/OverallPerf.rpt"));
                    rptname.FileName = Server.MapPath("~/Reports/OverallPerf.rpt");
                    rptname.Refresh();
                    rptname.SetDataSource(dt);
                    rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                    DataTable dtFrom = CommonClasses.Execute("SELECT * into #TempFrom from (select SPR_FROM AS [FromA],'' AS [FromB],'' AS [FromC],'' AS [FromD] from SUPPLIER_PERFORMANCE_REMARK where ES_DELETE=0 and SPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "' AND SPR_CODE=-2147483648 UNION select '' AS [FromA],SPR_FROM AS [FromB],'' AS [FromC],'' AS [FromD] from SUPPLIER_PERFORMANCE_REMARK where ES_DELETE=0 and SPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "' AND SPR_CODE=-2147483647 UNION select '' AS [FromA],'' AS [FromB],SPR_FROM AS [FromC],'' AS [FromD] from SUPPLIER_PERFORMANCE_REMARK where ES_DELETE=0 and SPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "' AND SPR_CODE=-2147483646 UNION select '' AS [FromA],'' AS [FromB],'' AS [FromC],SPR_FROM AS [FromD] from SUPPLIER_PERFORMANCE_REMARK where ES_DELETE=0 and SPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "' AND SPR_CODE=-2147483645) AS ss SELECT MAX([FromA]) AS [FromA],MAX([FromB]) AS [FromB],MAX([FromC]) AS [FromC],MAX([FromD]) AS [FromD] FRom #TempFrom drop TABLE #TempFrom");
                    if (dtFrom.Rows.Count > 0)
                    {
                        rptname.SetParameterValue("txtFromA", dtFrom.Rows[0]["FromA"]);
                        rptname.SetParameterValue("txtFromB", dtFrom.Rows[0]["FromB"]);
                        rptname.SetParameterValue("txtFromC", dtFrom.Rows[0]["FromC"]);
                        rptname.SetParameterValue("txtFromD", dtFrom.Rows[0]["FromD"]);
                    }
                    else
                    {
                        PanelMsg.Visible = true;
                        lblmsg.Text = "Please Insert Data in Supplier Performance Master...";
                        return;
                    }
                    rptname.SetParameterValue("txtDate", dtMonth.ToString("MM yyyy"));
                    rptname.SetParameterValue("Title", "Overall Performance Of Supplier");
                    CrystalReportViewer1.ReportSource = rptname;
                }
                else
                {
                    PanelMsg.Visible = true;
                    lblmsg.Text = " No Record Found! ";
                }
                #endregion
            }
            #endregion OverAllPerf_Supplier_Wise

            #region DeliveryPerf_Monitering_Sheet
            else if (str == "DeliveryPerf")
            {
                lblTitle.Text = "Delivery Performance Monitoring Sheet";
                Page.Title = "Delivery Performance Monitoring Sheet";
                /* OkQty/ScheduleQty*/
                //Query = "SELECT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM.SPOM_PONO,IWM.IWM_TYPE,ISNULL((select ISNULL(sum(IWD.IWD_REV_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWM.IWM_CODE=IWM1.IWM_CODE AND IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_REV_QTY,ISNULL((select ISNULL(sum(IWD.IWD_CON_OK_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWM.IWM_CODE=IWM1.IWM_CODE AND IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_OK_QTY,ISNULL((select ISNULL(sum(IWD.IWD_CON_REJ_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWM.IWM_CODE=IWM1.IWM_CODE AND IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_REJ_QTY,ISNULL((select ISNULL(PSD1.PSD_W1_QTY,0) + ISNULL(PSD1.PSD_W2_QTY,0)+ ISNULL(PSD1.PSD_W3_QTY,0) + ISNULL(PSD1.PSD_W4_QTY,0) AS PSD_TOTSCHEDULE_QTY from PURCHASE_SCHEDULE_MASTER as PSM1 INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD1 ON PSM1.PSM_CODE = PSD1.PSD_PSM_CODE WHERE PSM1.ES_DELETE=0 AND PSM1.PSM_CODE= PSM.PSM_CODE and P.P_CODE =PSM1.PSM_P_CODE and PSD1.PSD_I_CODE=I.I_CODE),0) AS Schedule_Qty INTO #Temp FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE inner join PURCHASE_SCHEDULE_MASTER as PSM on P.P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE WHERE " + Cond + " datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND (IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND='1' and P_ACTIVE_IND='1' AND PSM.ES_DELETE=0 AND PSD.PSD_I_CODE=IWD.IWD_I_CODE AND PSD.PSD_PO_CODE=SPOM.SPOM_CODE group by P.P_CODE,P.P_NAME,P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM_PONO,IWM_TYPE,PSM_CODE,PSM_P_CODE,IWM_CODE,IWD_I_CODE select P_CODE,P_NAME,P_VEND_CODE	,I_CODE,I_CODENO,I_NAME	,SPOM_PONO,IWM_TYPE,case when Schedule_Qty=0 then 0 else (IWD_CON_REJ_QTY/Schedule_Qty)*100 end as IWD_REV_QTY,IWD_CON_OK_QTY,IWD_CON_REJ_QTY	,Schedule_Qty,case when Schedule_Qty=0 then 0 else (IWD_CON_OK_QTY/Schedule_Qty)*100 end as Perf,case when IWD_CON_OK_QTY<=Schedule_Qty then Schedule_Qty-IWD_CON_OK_QTY else 0 end as ShortQty from #Temp ORDER BY Perf DESC,P_NAME asc drop table #Temp";
                //Query = "SELECT DISTINCT P.P_CODE,P.P_NAME,ISNULL(P.P_VEND_CODE,'') AS P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM.SPOM_PONO,IWM.IWM_TYPE,ISNULL((select ISNULL(sum(IWD1.IWD_REV_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_REV_QTY,ISNULL((select ISNULL(sum(IWD1.IWD_CON_OK_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_OK_QTY,ISNULL((select ISNULL(sum(IWD1.IWD_CON_REJ_QTY),0) FROM INWARD_MASTER IWM1 INNER JOIN INWARD_DETAIL IWD1 ON IWM1.IWM_CODE = IWD1.IWD_IWM_CODE where IWD.IWD_I_CODE=IWD1.IWD_I_CODE AND IWM_P_CODE=IWM1.IWM_P_CODE and datepart(mm,IWM1.IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM1.IWM_DATE)='" + dtMonth.ToString("yyyy") + "'),0) AS IWD_CON_REJ_QTY,ISNULL((select ISNULL(PSD1.PSD_W1_QTY,0) + ISNULL(PSD1.PSD_W2_QTY,0) + ISNULL(PSD1.PSD_W3_QTY,0) + ISNULL(PSD1.PSD_W4_QTY,0) AS PSD_TOTSCHEDULE_QTY from PURCHASE_SCHEDULE_MASTER as PSM1 INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD1 ON PSM1.PSM_CODE = PSD1.PSD_PSM_CODE WHERE PSM1.ES_DELETE=0 AND PSM1.PSM_CODE= PSM.PSM_CODE and P.P_CODE =PSM1.PSM_P_CODE and PSD1.PSD_I_CODE=I.I_CODE AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'),0) AS Schedule_Qty INTO #Temp FROM INWARD_MASTER IWM INNER JOIN INWARD_DETAIL IWD ON IWM.IWM_CODE = IWD.IWD_IWM_CODE INNER JOIN PARTY_MASTER P ON IWM.IWM_P_CODE = P.P_CODE INNER JOIN ITEM_MASTER I ON IWD.IWD_I_CODE = I.I_CODE inner join SUPP_PO_MASTER SPOM on IWD.IWD_CPOM_CODE=SPOM.SPOM_CODE inner join PURCHASE_SCHEDULE_MASTER as PSM on P.P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE and PSD.PSD_I_CODE= IWD.IWD_I_CODE WHERE " + Cond + " datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND (IWM.ES_DELETE = 0) AND(SPOM.ES_DELETE = 0) AND IWD.IWD_INSP_FLG='1' and P.ES_DELETE=0 AND P_INHOUSE_IND='1' and P_ACTIVE_IND='1' AND PSM.ES_DELETE=0 AND PSD.PSD_I_CODE=IWD.IWD_I_CODE AND PSD.PSD_PO_CODE=SPOM.SPOM_CODE group by P.P_CODE,P.P_NAME,P_VEND_CODE,I.I_CODE,I.I_CODENO,I.I_NAME,SPOM_PONO,IWM_TYPE,PSM_CODE,PSM_P_CODE,IWM_CODE,IWD_I_CODE select P_CODE,P_NAME,P_VEND_CODE,I_CODE,I_CODENO,I_NAME,SPOM_PONO,IWM_TYPE,case when (Schedule_Qty=0 AND IWD_CON_OK_QTY<=Schedule_Qty) then 0 else ((Schedule_Qty-IWD_CON_OK_QTY)/Schedule_Qty)*100 end as IWD_REV_QTY,IWD_CON_OK_QTY,IWD_CON_REJ_QTY	,Schedule_Qty,case when Schedule_Qty=0 then 0 else (IWD_CON_OK_QTY/Schedule_Qty)*100 end as Perf,case when IWD_CON_OK_QTY<=Schedule_Qty then Schedule_Qty-IWD_CON_OK_QTY else 0 end as ShortQty from #Temp ORDER BY Perf DESC,P_NAME asc drop table #Temp";
                //Query = "SELECT DISTINCT P_CODE,P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,SPOM_PONO,IWD_I_CODE,I_CODENO,I_NAME,SUM(IWD_REV_QTY) AS IWD_REV_QTY,SUM(IWD_CON_OK_QTY) AS IWD_CON_OK_QTY,SUM(IWD_CON_REJ_QTY) AS IWD_CON_REJ_QTY into #Temp FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE INNER JOIN PARTY_MASTER ON IWM_P_CODE = PARTY_MASTER.P_CODE INNER JOIN ITEM_MASTER ON IWD_I_CODE = I_CODE inner join SUPP_PO_MASTER SPOM on IWD_CPOM_CODE=SPOM_CODE WHERE " + Cond + " datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND (INWARD_MASTER.ES_DELETE = 0) GROUP BY P_CODE,P_NAME,IWD_I_CODE,I_CODENO,I_NAME,P_VEND_CODE,SPOM_PONO select P_CODE,P_NAME,P_VEND_CODE,SPOM_PONO,IWD_I_CODE,I_CODENO,I_NAME,IWD_REV_QTY,IWD_CON_OK_QTY,IWD_CON_REJ_QTY,PSD_MONTH_QTY as Schedule_Qty from #Temp inner join PURCHASE_SCHEDULE_MASTER as PSM on P_CODE=PSM.PSM_P_CODE INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE and PSD.PSD_I_CODE= IWD_I_CODE where " + Cond + " datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "' drop table #Temp";

                Query = "select P.P_CODE,P.P_NAME,ISNULL(P_VEND_CODE,'') AS P_VEND_CODE,PSD_PO_CODE,ISNULL((SELECT DISTINCT top(1)ISNULL(SPOM_PONO,'') FROM SUPP_PO_MASTER WHERE SUPP_PO_MASTER.ES_DELETE=0 AND SPOM_CODE=PSD_PO_CODE ),0) AS SPOM_PONO,I_CODE,I_CODENO,I_NAME,PSD_MONTH_QTY AS Schedule_Qty,ISNULL((SELECT ISNULL(SUM(IWD_CON_OK_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_OK_QTY,ISNULL((SELECT ISNULL(SUM(IWD_REV_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_REV_QTY,ISNULL((SELECT ISNULL(SUM(IWD_CON_REJ_QTY),0) FROM INWARD_MASTER INNER JOIN INWARD_DETAIL ON IWM_CODE = IWD_IWM_CODE WHERE INWARD_MASTER.ES_DELETE=0 AND IWM_P_CODE=PSM.PSM_P_CODE AND datepart(mm,IWM_DATE)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,IWM_DATE)='" + dtMonth.ToString("yyyy") + "' AND IWD_I_CODE=PSD.PSD_I_CODE AND IWM_INWARD_TYPE IN (1,0) ),0) AS IWD_CON_REJ_QTY from PURCHASE_SCHEDULE_MASTER PSM INNER JOIN PURCHASE_SCHEDULE_DETAIL PSD ON PSM.PSM_CODE = PSD.PSD_PSM_CODE INNER JOIN PARTY_MASTER P ON PSM.PSM_P_CODE=P.P_CODE INNER JOIN ITEM_MASTER ON PSD.PSD_I_CODE = I_CODE AND " + Cond + " PSM.ES_DELETE=0 AND P.ES_DELETE=0 AND datepart(mm,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("MM") + "' AND datepart(yyyy,PSM_SCHEDULE_MONTH)='" + dtMonth.ToString("yyyy") + "'";
                DataSet ds = new DataSet();
                DataTable dt = new DataTable();
                dt = CommonClasses.Execute(Query);
                #region Bind_ds_To_Rpt
                if (dt.Rows.Count > 0)
                {
                    ReportDocument rptname = null;
                    rptname = new ReportDocument();

                    rptname.Load(Server.MapPath("~/Reports/DeliveryPerf.rpt"));
                    rptname.FileName = Server.MapPath("~/Reports/DeliveryPerf.rpt");
                    rptname.Refresh();
                    rptname.SetDataSource(dt);
                    rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                    rptname.SetParameterValue("txtDate", dtMonth.ToString("MM yyyy"));
                    rptname.SetParameterValue("Title", "Delivery Performance Monitoring Sheet");
                    /*For fetch records from database and Calculate perf, Show Perf in range chart and calculate in Formula for perf as per chart*/
                    //Fromlimit to Tolimit
                    DataTable dtDeliveryPerf = CommonClasses.Execute("SELECT 'Performance' AS Perf,[95] as [100],[90] as [95],[80] as [90],[0] as [80] FROM (SELECT DPR_FROM,DPR_TO FROM DELIVERY_PERF_RANGE where ES_DELETE=0 and DPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "') AS DeliveryPerfTable PIVOT (AVG(DPR_TO) FOR DPR_FROM IN ([0],[100],[95],[90],[80])) AS PivotTable ");
                    //% 
                    DataTable dtDeliveryPer = CommonClasses.Execute("SELECT 'Performance1' AS Perf,[95] as [100],[90] as [95],[80] as [90],[0] as [80] FROM (SELECT DPR_FROM,DPR_PER FROM DELIVERY_PERF_RANGE where ES_DELETE=0 and DPR_CM_COMP_ID='" + (string)Session["CompanyId"] + "') AS DeliveryPerfTable PIVOT (AVG(DPR_PER) FOR DPR_FROM IN ([0],[100],[95],[90],[80])) AS PivotTable ");
                    if (dtDeliveryPerf.Rows.Count == 0)
                    {
                        PanelMsg.Visible = true;
                        lblmsg.Text = "Please Insert Data in Delivery Performance Master...";
                        return;
                    }
                    else
                    {
                        rptname.SetParameterValue("txtA", dtDeliveryPerf.Rows[0]["100"].ToString());
                        rptname.SetParameterValue("txtB", dtDeliveryPerf.Rows[0]["95"].ToString());
                        rptname.SetParameterValue("txtC", dtDeliveryPerf.Rows[0]["90"].ToString());
                        rptname.SetParameterValue("txtD", dtDeliveryPerf.Rows[0]["80"].ToString());
                        rptname.SetParameterValue("txtAPer", dtDeliveryPer.Rows[0]["100"].ToString());
                        rptname.SetParameterValue("txtBPer", dtDeliveryPer.Rows[0]["95"].ToString());
                        rptname.SetParameterValue("txtCPer", dtDeliveryPer.Rows[0]["90"].ToString());
                        rptname.SetParameterValue("txtDPer", dtDeliveryPer.Rows[0]["80"].ToString());
                    }
                    CrystalReportViewer1.ReportSource = rptname;
                }
                else
                {
                    PanelMsg.Visible = true;
                    lblmsg.Text = " No Record Found! ";
                }
                #endregion
            }
            #endregion DeliveryPerf_Monitering_Sheet

        }
        catch (Exception Ex)
        {
        }
    }
    #endregion Bind_ds_To_Rpt

    #region btnCancel_Click
    protected void btnCancel_Click(object sender, EventArgs e)
    {
        try
        {
            if (ViewState["str"].ToString() == "QualityPerf")
                Response.Redirect("~/RoportForms/VIEW/QualityPerfReportView.aspx", false);
            else if (ViewState["str"].ToString() == "Overall")
                Response.Redirect("~/RoportForms/VIEW/OverallPerfView.aspx", false);
            else if (ViewState["str"].ToString() == "DeliveryPerf")
                Response.Redirect("~/RoportForms/VIEW/DeliveryPerfView.aspx", false);
        }
        catch (Exception Ex)
        {
            CommonClasses.SendError("Purchase Order Amendment Register", "btnCancel_Click", Ex.Message);
        }
    }
    #endregion btnCancel_Click
}

