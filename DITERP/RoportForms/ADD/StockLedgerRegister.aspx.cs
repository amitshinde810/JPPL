using System;
using System.Data;
using System.Web.UI;
using CrystalDecisions.CrystalReports.Engine;
using System.Web.UI.HtmlControls;
using ZXing;
using System.IO;
using System.Drawing;
using System.Drawing.Imaging;
using QRCoder;
using System.Collections.Generic;
using System.Linq;
using System.Web.UI.WebControls;
using System.Net;
using System.Net.Mail;
using System.Configuration;

public partial class RoportForms_ADD_StockLedgerRegister : System.Web.UI.Page
{
    DatabaseAccessLayer DL_DBAccess = null;

    protected void Page_Load(object sender, EventArgs e)
    {
        HtmlGenericControl home = (HtmlGenericControl)this.Page.Master.FindControl("Menus").FindControl("Production");
        home.Attributes["class"] = "active";
        HtmlGenericControl home1 = (HtmlGenericControl)this.Page.Master.FindControl("Menus").FindControl("Production1MV");
        home1.Attributes["class"] = "active";
    }
    #region Page_Init
    protected void Page_Init(object sender, EventArgs e)
    {
        try
        {
            string Title = Request.QueryString[0];
            bool ChkAll = Convert.ToBoolean(Request.QueryString[1].ToString());
            bool ChkComp = Convert.ToBoolean(Request.QueryString[2].ToString());
            string From = Request.QueryString[3].ToString();
            string To = Request.QueryString[4].ToString();
            string Type = Request.QueryString[6].ToString();
            bool ChkCatAll = Convert.ToBoolean(Request.QueryString[7].ToString());

            if (From == "" && To == "")
            {
                From = Session["CompanyOpeningDate"].ToString();
                To = Session["CompanyClosingDate"].ToString();
            }

            string i_name = Request.QueryString[5].ToString();
            string detail = Request.QueryString[6].ToString();
            string category = Request.QueryString[8].ToString();
            string WithVal = Request.QueryString[9].ToString();

            if (detail == "STORE")
            {
                GenerateReport1(Title, ChkAll.ToString(), ChkComp.ToString(), From, To, i_name, Type, category, ChkCatAll.ToString(), WithVal);
            }
            else
            {
                GenerateReport(Title, ChkAll.ToString(), ChkComp.ToString(), From, To, i_name, Type, category, ChkCatAll.ToString(), WithVal);
            }
        }
        catch (Exception)
        {

        }
    }
    #endregion

    #region GenerateReport
    private void GenerateReport(string Title, string chkdate, string chkComp, string From, string To, string i_name, string Type, string category, string chkCat, string WithVal)
    {
        DL_DBAccess = new DatabaseAccessLayer();
        string Query = "";

        #region Detail
        if (Type == "Detail")
        {
            Query = "select I_CODENO,STL_DOC_NUMBER,STL_DOC_DATE,isnull(cast((case when STL_DOC_QTY > 0 THEN STL_DOC_QTY end) as numeric(10,3)),0) as ADD_QTY,isnull(ABS(cast((case when STL_DOC_QTY < 0 THEN STL_DOC_QTY end) as numeric(10,3))),0) as REM_QTY,STL_CODE,(CASE STL_DOC_TYPE WHEN 'IWIM' THEN 'MATERIAL INWARD' WHEN 'ISSPROD' THEN 'ISSUE TO PRODUCTION' WHEN 'PRODTOSTORE' THEN 'PRODUCTION TO STORE' WHEN 'EXPINV' THEN 'EXPORT INVOICE' WHEN 'TAXINV' THEN 'TAX INVOICE' WHEN 'STCADJ' THEN 'STOCK ERROR CORRECTION' END) AS STL_DOC_TYPE,STL_I_CODE,I_NAME,isnull(cast((select SUM(STL_DOC_QTY) from STOCK_LEDGER SOL where STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' AND STL.STL_I_CODE=SOL.STL_I_CODE) as numeric(10,3)),0) As OpenStoc from STOCK_LEDGER STL,ITEM_MASTER where  ITEM_MASTER.ES_DELETE=0 AND STL_I_CODE=I_CODE";
            if (chkCat.ToUpper() != "TRUE")
            {
                Query = Query + " AND I_CAT_CODE='" + category + "'";
            }
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = Query + " and ITEM_MASTER.I_CODE='" + i_name + "' ";
            }
            // Query = Query + " and STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "'   ";
            DataSet ds = new DataSet();
            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStockLedgerRegister.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStockLedgerRegister.rpt");
                rptname.Refresh();
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", " From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        #endregion

        #region Summary
        else if (Type == "Summary")
        {
            string plantCode = Request.QueryString[10].ToString();


            string pdfReport = Request.QueryString[11].ToString();

            //Query = "select I_CODENO,I_NAME,sum(isnull(cast((case when STL_DOC_QTY > 0 THEN STL_DOC_QTY end) as numeric(10,3)),0)) as ADD_QTY,sum(isnull(ABS(cast((case when STL_DOC_QTY < 0 THEN STL_DOC_QTY end) as numeric(10,3))),0)) as REM_QTY,isnull(cast((select SUM(STL_DOC_QTY) from STOCK_LEDGER SOL where STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' AND STL.STL_I_CODE=SOL.STL_I_CODE) as numeric(10,3)),0) As OpenStoc from STOCK_LEDGER STL,ITEM_MASTER where  STL_I_CODE=I_CODE";
            //Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND SOL.STL_CODE=STL.STL_CODE AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ADD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND SOL.STL_CODE=STL.STL_CODE AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS REM_QTY,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where (ITEM_MASTER.I_ACTIVE_IND = 1)";
            //Hiten Added Query
            //Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ADD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS REM_QTY,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc,I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where  ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1)";
            //after plant 
            //Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "') AND SOL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "')) AS numeric(10, 3)), 0) AS ADD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "') AND SOL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "') ) AS numeric(10, 3)), 0) AS REM_QTY,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)  AND SOL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "')) AS numeric(10, 3)), 0) AS OpenStoc,I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where  ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1) AND STL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "')";


            //AFTER optimization 
            //Query = "SELECT ISNULL(ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)),0) AS ADD_QTY , ISNULL(ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)),0) AS REM_QTY, STL_I_CODE,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (SOL.STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (SOL.STL_I_CODE = STOCK_LEDGER.STL_I_CODE)   AND SOL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT= '" + plantCode + "')) AS numeric(10, 3)), 0) AS OpenStoc   into #temp  FROM STOCK_LEDGER WHERE     (STL_DOC_DATE between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "') AND STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "') GROUP BY  STL_I_CODE   select  I_CODENO,	 I_NAME	, ISNULL(ADD_QTY,0) AS  ADD_QTY, ISNULL(REM_QTY,0) AS 	REM_QTY, 	ISNULL(OpenStoc,0) AS OpenStoc,I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT from #temp RIGHT OUTER JOIN ITEM_MASTER ON  STL_I_CODE = ITEM_MASTER.I_CODE WHERE  ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1) ";
            Query = "SELECT ISNULL(ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)),0) AS ADD_QTY , ISNULL(ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)),0) AS REM_QTY, STL_I_CODE  into #temp  FROM STOCK_LEDGER WHERE     (STL_DOC_DATE between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "') AND STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT='" + plantCode + "') GROUP BY  STL_I_CODE   select I_CODE,  I_CODENO,	 I_NAME	, ISNULL(ADD_QTY,0) AS  ADD_QTY, ISNULL(REM_QTY,0) AS 	REM_QTY, 	ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (SOL.STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (SOL.STL_I_CODE = I_CODE)   AND SOL.STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT= '" + plantCode + "')) AS numeric(10, 3)), 0) AS OpenStoc ,I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT from #temp RIGHT OUTER JOIN ITEM_MASTER ON  STL_I_CODE = ITEM_MASTER.I_CODE WHERE  ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1) ";
            if (chkCat.ToUpper() != "TRUE")
            {
                Query = Query + " AND I_CAT_CODE='" + category + "'";
            }
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = Query + " and ITEM_MASTER.I_CODE='" + i_name + "' ";
            }
             
            //Query = Query + " ) as A GROUP BY I_CODENO,I_NAME,ADD_QTY,REM_QTY,OpenStoc,I_INV_RATE,I_UWEIGHT";
            Query = Query + "   drop table #temp  ";
            DataSet ds = new DataSet();
            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                string prefix = "plant 2";
                if (plantCode == "-2147483648")
                {
                    prefix = "Plant 1";
                }
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                if (WithVal == "WithAmt")
                {
                    rptname.Load(Server.MapPath("~/Reports/rptStockLedgerDetailRegisterWithVal.rpt"));
                    rptname.FileName = Server.MapPath("~/Reports/rptStockLedgerDetailRegisterWithVal.rpt");
                    rptname.Refresh();
                    //rptname.SetParameterValue("txtName", Session["CompanyName"].ToString());
                    rptname.SetDataSource(dt);
                    rptname.SetParameterValue("txtWithVal", "WithVal");
                    rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                    rptname.SetParameterValue("txtPeriod", prefix + " From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                    CrystalReportViewer1.ReportSource = rptname;
                }
                else
                {
                    rptname.Load(Server.MapPath("~/Reports/rptStockLedgerDetailRegister.rpt"));
                    rptname.FileName = Server.MapPath("~/Reports/rptStockLedgerDetailRegister.rpt");
                    rptname.Refresh();
                    //rptname.SetParameterValue("txtName", Session["CompanyName"].ToString());
                    rptname.SetDataSource(dt);
                    // rptname.SetParameterValue("txtWithVal", "");
                    rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                    rptname.SetParameterValue("txtPeriod", prefix + " From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                    CrystalReportViewer1.ReportSource = rptname;
                }
                if (pdfReport.ToUpper() == "TRUE")
                {


                    DateTime now = DateTime.Now;
                    string invoiceName = Server.MapPath("~/UpLoadPath/STOCK/" + now.Year + now.Month + now.Day + now.Hour + now.Minute + now.Second + now.Millisecond + "STOCK.pdf");
                    rptname.ExportToDisk(CrystalDecisions.Shared.ExportFormatType.PortableDocFormat, invoiceName);

                    string path = invoiceName;
                    WebClient client = new WebClient();
                    Byte[] buffer = client.DownloadData(path);
                    if (buffer != null)
                    {
                        Response.ContentType = "application/pdf";
                        Response.AddHeader("content-length", buffer.Length.ToString());
                        Response.BinaryWrite(buffer);
                    }


                    try
                    {
                        //SendEmail(dsTaxInvoiceGST.Tables[0].Rows[0]["P_EMAIL"].ToString(), invoiceName, dsTaxInvoiceGST.Tables[0].Rows[0]["P_NAME"].ToString(), dtComp.Rows[0]["CM_NAME"].ToString(), invoicenumber, dtComp.Rows[0]["CM_BANK_NAME"].ToString(), dtComp.Rows[0]["CM_NAME"].ToString(), dtComp.Rows[0]["CM_BANK_ACC_NO"].ToString(), dtComp.Rows[0]["CM_IFSC_CODE"].ToString(), dtComp.Rows[0]["CM_B_SWIFT_CODE"].ToString(), dtComp.Rows[0]["CM_ACC_TYPE"].ToString());

                    }
                    catch (Exception ex)
                    {


                    }
                }  
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        #endregion

        #region StdVSActual
        else if (Type == "StdVSActual")
        {


            Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (CONVERT(DATE,STL_DOC_DATE) < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='PRODTOSTORE' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutSUBINM' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DISPATCH_SUB,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIAP' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS SUB_INW,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='TAXINV' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS INVOICE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_ADD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_LESS,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='ISSPROD' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ISSUE_PROD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIC' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS CUST_REJ,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIFP' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROCESS_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutJWINM' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS LABOUR_SALE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCIN' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCOUT' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_OUT,ISNULL(CAST((SELECT ABS(SUM(STL_DOC_QTY )) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='SubContractorRejection' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS REJ_MATERIAL, ISNULL(CAST((SELECT (SUM(STL_DOC_QTY)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (STL_DOC_DATE <= '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)),0) AS CLOSE_STOCK from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1)";


            Query = Query + " AND I_CAT_CODE='-2147483648'";
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = Query + " and ITEM_MASTER.I_CODE='" + i_name + "' ";
            }

            if (chkdate.ToUpper() != "TRUE")
            {
                Query = Query + " and CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "'   ";
            }
            Query = Query + " ) as A GROUP BY I_CODENO, I_NAME,PROD_QTY,DISPATCH_SUB,SUB_INW,INVOICE,CLOSE_STOCK,OpenStoc,STOCK_ADJ_ADD,STOCK_ADJ_LESS,ISSUE_PROD,CUST_REJ,LABOUR_SALE,PROCESS_INWARD,DC_INWARD,DC_OUT,REJ_MATERIAL";
            DataSet ds = new DataSet();
            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStockLedgerMIS.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStockLedgerMIS.rpt");
                rptname.Refresh();
                //rptname.SetParameterValue("txtName", Session["CompanyName"].ToString());
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", " From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        #endregion

        #region MIS
        else
        {
            string plantCode = Request.QueryString[10].ToString();

            //Query = "select I_CODENO,I_NAME,sum(isnull(cast((case when STL_DOC_QTY > 0 THEN STL_DOC_QTY end) as numeric(10,3)),0)) as ADD_QTY,sum(isnull(ABS(cast((case when STL_DOC_QTY < 0 THEN STL_DOC_QTY end) as numeric(10,3))),0)) as REM_QTY,isnull(cast((select SUM(STL_DOC_QTY) from STOCK_LEDGER SOL where STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' AND STL.STL_I_CODE=SOL.STL_I_CODE) as numeric(10,3)),0) As OpenStoc from STOCK_LEDGER STL,ITEM_MASTER where  STL_I_CODE=I_CODE";
            //Hiten Added Query
            //Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='PRODTOSTORE' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutSUBINM' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DISPATCH_SUB,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIAP' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS SUB_INW,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='TAXINV' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS INVOICE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_ADD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_LESS,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='ISSPROD' AND (STL_DOC_DATE between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ISSUE_PROD,ISNULL(CAST((SELECT ABS(SUM(STL_DOC_QTY)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (STL_DOC_DATE <= '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "') ) AS numeric(10, 3)), 0) AS CLOSE_STOCK from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where (ITEM_MASTER.I_ACTIVE_IND = 1)";

            //old working query
            Query = "SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (CONVERT(DATE,STL_DOC_DATE) < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='PRODTOSTORE' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutSUBINM' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DISPATCH_SUB,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIAP' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS SUB_INW,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='TAXINV' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS INVOICE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_ADD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_LESS,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='ISSPROD' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ISSUE_PROD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIC' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS CUST_REJ,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIFP' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROCESS_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutJWINM' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS LABOUR_SALE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCIN' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCOUT' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_OUT,ISNULL(CAST((SELECT ABS(SUM(STL_DOC_QTY )) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='SubContractorRejection' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS REJ_MATERIAL, ISNULL(CAST((SELECT (SUM(STL_DOC_QTY)) AS Expr1 FROM STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (STL_DOC_DATE <= '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)),0) AS CLOSE_STOCK from STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1)";

            //Query = " select * into #STOCK_LEDGER from STOCK_LEDGER  where STL_STORE_TYPE IN (SELECT STORE_CODE FROM STORE_MASTER where STORE_PLANT= '" + plantCode + "') SELECT * FROM (select ITEM_MASTER.I_CODENO,ITEM_MASTER.I_NAME,ISNULL(CAST((SELECT SUM(STL_DOC_QTY) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (CONVERT(DATE,STL_DOC_DATE) < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "') AND (STL_I_CODE = ITEM_MASTER.I_CODE)) AS numeric(10, 3)), 0) AS OpenStoc,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='PRODTOSTORE' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROD_QTY,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutSUBINM' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DISPATCH_SUB,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIAP' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS SUB_INW,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='TAXINV' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS INVOICE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_ADD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='STCADJ' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS STOCK_ADJ_LESS,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='ISSPROD' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS ISSUE_PROD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIC' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS CUST_REJ,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='IWIFP' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS PROCESS_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='OutJWINM' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS LABOUR_SALE,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY > 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCIN' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_INWARD,ISNULL(CAST((SELECT ABS(SUM(CASE WHEN STL_DOC_QTY < 0 THEN STL_DOC_QTY END)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='DCOUT' AND  (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS DC_OUT,ISNULL(CAST((SELECT ABS(SUM(STL_DOC_QTY )) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE =ITEM_MASTER.I_CODE) AND STL_DOC_TYPE='SubContractorRejection' AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)), 0) AS REJ_MATERIAL, ISNULL(CAST((SELECT (SUM(STL_DOC_QTY)) AS Expr1 FROM #STOCK_LEDGER AS SOL WHERE (STL_I_CODE = ITEM_MASTER.I_CODE) AND (STL_DOC_DATE <= '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) AS numeric(10, 3)),0) AS CLOSE_STOCK from #STOCK_LEDGER STL RIGHT OUTER JOIN ITEM_MASTER ON STL.STL_I_CODE = ITEM_MASTER.I_CODE where ITEM_MASTER.ES_DELETE=0 AND (ITEM_MASTER.I_ACTIVE_IND = 1)";


             
            Query = Query + " AND I_CAT_CODE='-2147483648'";
            //}
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = Query + " and ITEM_MASTER.I_CODE='" + i_name + "' ";
            }

            if (chkdate.ToUpper() != "TRUE")
            {
                Query = Query + " and CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "'   ";
            }
            Query = Query + " ) as A GROUP BY I_CODENO, I_NAME,PROD_QTY,DISPATCH_SUB,SUB_INW,INVOICE,CLOSE_STOCK,OpenStoc,STOCK_ADJ_ADD,STOCK_ADJ_LESS,ISSUE_PROD,CUST_REJ,LABOUR_SALE,PROCESS_INWARD,DC_INWARD,DC_OUT,REJ_MATERIAL";

           // Query = Query + "   DROP TABLE #STOCK_LEDGER ";
            DataSet ds = new DataSet();

            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                string prefix = "plant 2";
                if (plantCode == "-2147483648")
                {
                    prefix = "Plant 1";
                }
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStockLedgerMIS.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStockLedgerMIS.rpt");
                rptname.Refresh();
                //rptname.SetParameterValue("txtName", Session["CompanyName"].ToString());
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", prefix+ " From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        #endregion
    }
    #endregion

    #region GenerateReport1
    private void GenerateReport1(string Title, string chkdate, string chkComp, string From, string To, string i_name, string Type, string category, string chkCat, string WithVal)
    {
        DL_DBAccess = new DatabaseAccessLayer();
        string Query = "";

        #region MIS
        string strCond = "";

        if (WithVal == "WithAmt")
        {
            //item specific
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = " select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND(CONVERT(DATE, IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483648]),0) AS [Inward StoreH],ISNULL(SUM([-2147483647]),0) AS [Main StoreH],ISNULL(SUM([-2147483646]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483645]),0) AS [RFM StoreH],ISNULL(SUM([-2147483644]),0) AS [RFP StoreH],ISNULL(SUM([-2147483643]),0) AS [RFI StoreH],ISNULL(SUM([-2147483642]),0) AS [RFD StoreH],ISNULL(SUM([-2147483641]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483640]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483639]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP DROP TABLE #TEMP1";
            }
            else
            {//for all item
               // Query = " select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483648]),0) AS [Inward StoreH],ISNULL(SUM([-2147483647]),0) AS [Main StoreH],ISNULL(SUM([-2147483646]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483645]),0) AS [RFM StoreH],ISNULL(SUM([-2147483644]),0) AS [RFP StoreH],ISNULL(SUM([-2147483643]),0) AS [RFI StoreH],ISNULL(SUM([-2147483642]),0) AS [RFD StoreH],ISNULL(SUM([-2147483641]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483640]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483639]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH  DROP TABLE #TEMP DROP TABLE #TEMP1";
                Query = " select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483637]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483637],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483648]),0) AS [Inward StoreH],ISNULL(SUM([-2147483647]),0) AS [Main StoreH],ISNULL(SUM([-2147483637]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483645]),0) AS [RFM StoreH],ISNULL(SUM([-2147483644]),0) AS [RFP StoreH],ISNULL(SUM([-2147483643]),0) AS [RFI StoreH],ISNULL(SUM([-2147483642]),0) AS [RFD StoreH],ISNULL(SUM([-2147483641]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483640]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483639]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483637],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH  DROP TABLE #TEMP DROP TABLE #TEMP1";
            }
            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStoreWiseItem.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStoreWiseItem.rpt");
                rptname.Refresh();
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", "Plant 1 Store Location wise Stock Report From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        else if (WithVal == "WithAmtPlant2")
        {
            //item specific
            if (chkComp.ToUpper() != "TRUE")
            {
                //Query = " select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND(CONVERT(DATE, IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483648]),0) AS [Inward StoreH],ISNULL(SUM([-2147483647]),0) AS [Main StoreH],ISNULL(SUM([-2147483646]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483645]),0) AS [RFM StoreH],ISNULL(SUM([-2147483644]),0) AS [RFP StoreH],ISNULL(SUM([-2147483643]),0) AS [RFI StoreH],ISNULL(SUM([-2147483642]),0) AS [RFD StoreH],ISNULL(SUM([-2147483641]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483640]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483639]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP DROP TABLE #TEMP1";
                //Query = " select ISNULL(SUM([-2147483636]),0) AS [Inward Store],ISNULL(SUM([-2147483637]),0) AS [Main Store],ISNULL(SUM([-2147483635]),0) AS [Foundry Store],ISNULL(SUM([-2147483634]),0) AS [RFM Store],ISNULL(SUM([-2147483633]),0) AS [RFP Store],ISNULL(SUM([-2147483632]),0) AS [RFI Store],ISNULL(SUM([-2147483631]),0) AS [RFD Store],ISNULL(SUM([-2147483630]),0) AS [Rejection Store],ISNULL(SUM([-2147483629]),0) AS [Casting Rework],ISNULL(SUM([-2147483628]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483636]),0) AS [Inward StoreH],ISNULL(SUM([-2147483637]),0) AS [Main StoreH],ISNULL(SUM([-2147483635]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483634]),0) AS [RFM StoreH],ISNULL(SUM([-2147483633]),0) AS [RFP StoreH],ISNULL(SUM([-2147483632]),0) AS [RFI StoreH],ISNULL(SUM([-2147483631]),0) AS [RFD StoreH],ISNULL(SUM([-2147483630]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483629]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483628]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP DROP TABLE #TEMP1";
                Query = "  select ISNULL(SUM([-2147483635]),0) AS [Inward Store],ISNULL(SUM([-2147483634]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483632]),0) AS [RFM Store],ISNULL(SUM([-2147483631]),0) AS [RFP Store],ISNULL(SUM([-2147483629]),0) AS [RFI Store],ISNULL(SUM([-2147483627]),0) AS [RFD Store],ISNULL(SUM([-2147483628]),0) AS [Rejection Store],ISNULL(SUM([-2147483633]),0) AS [Casting Rework],ISNULL(SUM([-2147483630]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483635],[-2147483634],[-2147483646],[-2147483632],[-2147483631],[-2147483629],[-2147483627],[-2147483628],[-2147483633],[-2147483630])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483635]),0) AS [Inward StoreH],ISNULL(SUM([-2147483634]),0) AS [Main StoreH],ISNULL(SUM([-2147483646]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483632]),0) AS [RFM StoreH],ISNULL(SUM([-2147483631]),0) AS [RFP StoreH],ISNULL(SUM([-2147483629]),0) AS [RFI StoreH],ISNULL(SUM([-2147483627]),0) AS [RFD StoreH],ISNULL(SUM([-2147483628]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483633]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483630]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "' )),0) AS BAL           ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483635],[-2147483634],[-2147483646],[-2147483632],[-2147483631],[-2147483629],[-2147483627],[-2147483628],[-2147483633],[-2147483630])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH  where  #TEMP.I_CODE='" + i_name + "'   DROP TABLE #TEMP DROP TABLE #TEMP1 ";
            }
            else
            {//for all item
                //Query = " select ISNULL(SUM([-2147483636]),0) AS [Inward Store],ISNULL(SUM([-2147483637]),0) AS [Main Store],ISNULL(SUM([-2147483635]),0) AS [Foundry Store],ISNULL(SUM([-2147483634]),0) AS [RFM Store],ISNULL(SUM([-2147483633]),0) AS [RFP Store],ISNULL(SUM([-2147483632]),0) AS [RFI Store],ISNULL(SUM([-2147483631]),0) AS [RFD Store],ISNULL(SUM([-2147483630]),0) AS [Rejection Store],ISNULL(SUM([-2147483629]),0) AS [Casting Rework],ISNULL(SUM([-2147483628]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483636]),0) AS [Inward StoreH],ISNULL(SUM([-2147483637]),0) AS [Main StoreH],ISNULL(SUM([-2147483635]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483634]),0) AS [RFM StoreH],ISNULL(SUM([-2147483633]),0) AS [RFP StoreH],ISNULL(SUM([-2147483632]),0) AS [RFI StoreH],ISNULL(SUM([-2147483631]),0) AS [RFD StoreH],ISNULL(SUM([-2147483630]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483629]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483628]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH   DROP TABLE #TEMP DROP TABLE #TEMP1";
                Query = "  select ISNULL(SUM([-2147483635]),0) AS [Inward Store],ISNULL(SUM([-2147483634]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483632]),0) AS [RFM Store],ISNULL(SUM([-2147483631]),0) AS [RFP Store],ISNULL(SUM([-2147483629]),0) AS [RFI Store],ISNULL(SUM([-2147483627]),0) AS [RFD Store],ISNULL(SUM([-2147483628]),0) AS [Rejection Store],ISNULL(SUM([-2147483633]),0) AS [Casting Rework],ISNULL(SUM([-2147483630]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483635],[-2147483634],[-2147483646],[-2147483632],[-2147483631],[-2147483629],[-2147483627],[-2147483628],[-2147483633],[-2147483630])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483635]),0) AS [Inward StoreH],ISNULL(SUM([-2147483634]),0) AS [Main StoreH],ISNULL(SUM([-2147483646]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483632]),0) AS [RFM StoreH],ISNULL(SUM([-2147483631]),0) AS [RFP StoreH],ISNULL(SUM([-2147483629]),0) AS [RFI StoreH],ISNULL(SUM([-2147483627]),0) AS [RFD StoreH],ISNULL(SUM([-2147483628]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483633]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483630]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "' )),0) AS BAL           ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483635],[-2147483634],[-2147483646],[-2147483632],[-2147483631],[-2147483629],[-2147483627],[-2147483628],[-2147483633],[-2147483630])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH   DROP TABLE #TEMP DROP TABLE #TEMP1 ";
            }
            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);
            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStoreWiseItem.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStoreWiseItem.rpt");
                rptname.Refresh();
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", "Plant 2 Store Location wise Stock Report From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        else if (WithVal == "WithoutAmt")
        {
            if (chkComp.ToUpper() != "TRUE")
            {
                Query = "   select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   into #TEMP from (SELECT ITEM.I_CODENO , ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL  ,ITEM.I_TARGET_WEIGHT AS FINISHWT, ITEM.I_DENSITY AS BDWT         FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE,ITEM.I_TARGET_WEIGHT, ITEM.I_DENSITY)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable             GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT  , FINISHWT,BDWT                SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME] , I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   FROM #TEMP  where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP       ";
                // Query = " select ISNULL(SUM([-2147483636]),0) AS [Inward Store],ISNULL(SUM([-2147483637]),0) AS [Main Store],ISNULL(SUM([-2147483635]),0) AS [Foundry Store],ISNULL(SUM([-2147483634]),0) AS [RFM Store],ISNULL(SUM([-2147483633]),0) AS [RFP Store],ISNULL(SUM([-2147483632]),0) AS [RFI Store],ISNULL(SUM([-2147483631]),0) AS [RFD Store],ISNULL(SUM([-2147483630]),0) AS [Rejection Store],ISNULL(SUM([-2147483629]),0) AS [Casting Rework],ISNULL(SUM([-2147483628]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT  into #TEMP       from (SELECT ITEM.I_CODENO, ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL, ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =STL.STL_STORE_TYPE AND IMD_I_CODE=ITEM.I_CODE  AND (CONVERT(DATE,IM_DATE)  between   '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS ACCEPT_PENDING FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT      select ISNULL(SUM([-2147483636]),0) AS [Inward StoreH],ISNULL(SUM([-2147483637]),0) AS [Main StoreH],ISNULL(SUM([-2147483635]),0) AS [Foundry StoreH],ISNULL(SUM([-2147483634]),0) AS [RFM StoreH],ISNULL(SUM([-2147483633]),0) AS [RFP StoreH],ISNULL(SUM([-2147483632]),0) AS [RFI StoreH],ISNULL(SUM([-2147483631]),0) AS [RFD StoreH],ISNULL(SUM([-2147483630]),0) AS [Rejection StoreH],ISNULL(SUM([-2147483629]),0) AS [Casting ReworkH],ISNULL(SUM([-2147483628]),0) AS [MECHINE ReworkH], I_CODE as I_CODEH,I_CODENO as I_CODENOH,I_NAME as I_NAMEH ,I_INV_RATE AS I_INV_RATEH,I_UWEIGHT AS I_UWEIGHTH into #TEMP1     from    (        SELECT     ITEM.I_CODENO, ITEM.I_NAME, '' AS STORE_NAME, IMD.IMD_To_STORE AS STORE_CODE, ITEM.I_CODE,I_INV_RATE,I_UWEIGHT ,  ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND   (STL_DOC_DATE <  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' )) ,0)  +ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE=IMD.IMD_To_STORE AND STL_I_CODE=ITEM.I_CODE AND (CONVERT(DATE,STL_DOC_DATE) between '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS BAL            ,ISNULL((SELECT SUM(IMD_REQ_QTY)  FROM ISSUE_MASTER,ISSUE_MASTER_DETAIL where ISSUE_MASTER.IM_CODE=ISSUE_MASTER_DETAIL.IM_CODE AND ISSUE_MASTER.ES_DELETE=0 AND IM_TRANS_TYPE=1 AND IMD_STORE_TYPE=0 AND IMD_To_STORE =IMD.IMD_To_STORE AND 	IMD_I_CODE=ITEM.I_CODE  AND  (CONVERT(DATE,IM_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')),0) AS ACCEPT_PENDING    FROM         ITEM_MASTER AS ITEM INNER JOIN ISSUE_MASTER_DETAIL AS IMD INNER JOIN ISSUE_MASTER AS IM ON IMD.IM_CODE = IM.IM_CODE ON ITEM.I_CODE = IMD.IMD_I_CODE  WHERE     (ITEM.I_CAT_CODE = - 2147483648) AND IM_TRANS_TYPE=1 GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE  ,I_INV_RATE,I_UWEIGHT ,IMD.IMD_To_STORE )    AS SOURCETABLE PIVOT (sum(ACCEPT_PENDING) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable    GROUP BY I_CODE,I_NAME ,I_CODENO,I_INV_RATE,I_UWEIGHT    SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME],ISNULL([Inward StoreH],0) AS [Inward StoreH],ISNULL([Main StoreH],0) AS [Main StoreH],ISNULL([Foundry StoreH],0) AS [Foundry StoreH],ISNULL([RFM StoreH],0) AS [RFM StoreH],ISNULL([RFP StoreH],0) AS [RFP StoreH],ISNULL([RFI StoreH],0) AS [RFI StoreH],ISNULL([RFD StoreH],0) AS [RFD StoreH],ISNULL([Rejection StoreH],0) AS [Rejection StoreH],ISNULL(([Casting ReworkH]),0) AS [Casting ReworkH],ISNULL(([MECHINE ReworkH]),0) AS [MECHINE ReworkH],ISNULL([I_CODEH],0) AS [I_CODEH],ISNULL([I_CODENOH],0) AS [I_CODENOH],ISNULL([I_NAMEH],0) AS [I_NAMEH],ISNULL(I_INV_RATE,0) AS I_INV_RATE,ISNULL(I_UWEIGHT,0) AS I_UWEIGHT  ,ISNULL(I_INV_RATEH,0) AS I_INV_RATEH,ISNULL(I_UWEIGHTH,0) AS I_UWEIGHTH   FROM #TEMP LEFT OUTER JOIN #TEMP1 ON #TEMP.I_CODE = #TEMP1.I_CODEH where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP DROP TABLE #TEMP1";
            }
            else
            {
                Query = "   select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   into #TEMP from (SELECT ITEM.I_CODENO , ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL  ,ITEM.I_TARGET_WEIGHT AS FINISHWT, ITEM.I_DENSITY AS BDWT         FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE,ITEM.I_TARGET_WEIGHT, ITEM.I_DENSITY)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable             GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT  , FINISHWT,BDWT                SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME] , I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   FROM #TEMP    DROP TABLE #TEMP       ";
            }

            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);

            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStoreWiseItem2.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStoreWiseItem2.rpt");
                rptname.Refresh();
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", "Plant 1 Stock Valuation Report From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }
        else if (WithVal == "WithoutAmtplant2")
        {
            if (chkComp.ToUpper() != "TRUE")
            {
                //Query = "   select ISNULL(SUM([-2147483648]),0) AS [Inward Store],ISNULL(SUM([-2147483647]),0) AS [Main Store],ISNULL(SUM([-2147483646]),0) AS [Foundry Store],ISNULL(SUM([-2147483645]),0) AS [RFM Store],ISNULL(SUM([-2147483644]),0) AS [RFP Store],ISNULL(SUM([-2147483643]),0) AS [RFI Store],ISNULL(SUM([-2147483642]),0) AS [RFD Store],ISNULL(SUM([-2147483641]),0) AS [Rejection Store],ISNULL(SUM([-2147483640]),0) AS [Casting Rework],ISNULL(SUM([-2147483639]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   into #TEMP from (SELECT ITEM.I_CODENO , ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL  ,ITEM.I_TARGET_WEIGHT AS FINISHWT, ITEM.I_DENSITY AS BDWT         FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE,ITEM.I_TARGET_WEIGHT, ITEM.I_DENSITY)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483648],[-2147483647],[-2147483646],[-2147483645],[-2147483644],[-2147483643],[-2147483642],[-2147483641],[-2147483640],[-2147483639])) AS PivotTable             GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT  , FINISHWT,BDWT                SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME] , I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   FROM #TEMP  where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP       ";
                Query = "   select ISNULL(SUM([-2147483636]),0) AS [Inward Store],ISNULL(SUM([-2147483637]),0) AS [Main Store],ISNULL(SUM([-2147483635]),0) AS [Foundry Store],ISNULL(SUM([-2147483634]),0) AS [RFM Store],ISNULL(SUM([-2147483633]),0) AS [RFP Store],ISNULL(SUM([-2147483632]),0) AS [RFI Store],ISNULL(SUM([-2147483631]),0) AS [RFD Store],ISNULL(SUM([-2147483630]),0) AS [Rejection Store],ISNULL(SUM([-2147483629]),0) AS [Casting Rework],ISNULL(SUM([-2147483628]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   into #TEMP from (SELECT ITEM.I_CODENO , ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL  ,ITEM.I_TARGET_WEIGHT AS FINISHWT, ITEM.I_DENSITY AS BDWT         FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE,ITEM.I_TARGET_WEIGHT, ITEM.I_DENSITY)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable             GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT  , FINISHWT,BDWT                SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME] , I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   FROM #TEMP  where  #TEMP.I_CODE='" + i_name + "'  DROP TABLE #TEMP       ";
            }
            else
            {
                Query = "   select ISNULL(SUM([-2147483636]),0) AS [Inward Store],ISNULL(SUM([-2147483637]),0) AS [Main Store],ISNULL(SUM([-2147483635]),0) AS [Foundry Store],ISNULL(SUM([-2147483634]),0) AS [RFM Store],ISNULL(SUM([-2147483633]),0) AS [RFP Store],ISNULL(SUM([-2147483632]),0) AS [RFI Store],ISNULL(SUM([-2147483631]),0) AS [RFD Store],ISNULL(SUM([-2147483630]),0) AS [Rejection Store],ISNULL(SUM([-2147483629]),0) AS [Casting Rework],ISNULL(SUM([-2147483628]),0) AS [MECHINE Rework], I_CODE,I_CODENO,I_NAME,I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   into #TEMP from (SELECT ITEM.I_CODENO , ITEM.I_NAME,  I_INV_RATE,I_UWEIGHT, STL.STL_STORE_TYPE AS STORE_CODE, ITEM.I_CODE,ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND (STL_DOC_DATE < '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "')) ,0)  + ISNULL((select ISNULL(SUM(STL_DOC_QTY),0) FROM STOCK_LEDGER where STL_STORE_TYPE= STL.STL_STORE_TYPE  AND STL_I_CODE=ITEM.I_CODE AND(CONVERT(DATE,STL_DOC_DATE) between  '" + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + "' and  '" + Convert.ToDateTime(To).ToString("dd/MMM/yyyy") + "')) ,0) AS BAL  ,ITEM.I_TARGET_WEIGHT AS FINISHWT, ITEM.I_DENSITY AS BDWT         FROM STOCK_LEDGER AS STL INNER JOIN ITEM_MASTER AS ITEM ON STL.STL_I_CODE = ITEM.I_CODE    WHERE     (ITEM.I_CAT_CODE = - 2147483648 )  GROUP BY ITEM.I_CODENO, ITEM.I_NAME,   ITEM.I_CODE ,I_INV_RATE,I_UWEIGHT,STL.STL_STORE_TYPE,ITEM.I_TARGET_WEIGHT, ITEM.I_DENSITY)   AS SOURCETABLE PIVOT (sum(BAL) for STORE_CODE IN (   [-2147483636],[-2147483637],[-2147483635],[-2147483634],[-2147483633],[-2147483632],[-2147483631],[-2147483630],[-2147483629],[-2147483628])) AS PivotTable             GROUP BY I_CODE,I_NAME ,I_CODENO ,I_INV_RATE,I_UWEIGHT  , FINISHWT,BDWT                SELECT   ISNULL([Inward Store],0) AS [Inward Store],ISNULL([Main Store],0) AS [Main Store],ISNULL([Foundry Store],0) AS [Foundry Store],ISNULL([RFM Store],0) AS [RFM Store],ISNULL([RFP Store],0) AS [RFP Store],ISNULL([RFI Store],0) AS [RFI Store],ISNULL([RFD Store],0) AS [RFD Store],ISNULL([Rejection Store],0) AS [Rejection Store],ISNULL(([Casting Rework]),0) AS [Casting Rework],ISNULL(([MECHINE Rework]),0) AS [MECHINE Rework],ISNULL([I_CODE],0) AS [I_CODE],ISNULL([I_CODENO],0) AS [I_CODENO],ISNULL([I_NAME],0) AS [I_NAME] , I_INV_RATE,I_UWEIGHT,FINISHWT,BDWT   FROM #TEMP     DROP TABLE #TEMP       ";
            }

            DataTable dt = new DataTable();
            dt = CommonClasses.Execute(Query);

            if (dt.Rows.Count > 0)
            {
                ReportDocument rptname = null;
                rptname = new ReportDocument();
                rptname.Load(Server.MapPath("~/Reports/rptStoreWiseItem2.rpt"));
                rptname.FileName = Server.MapPath("~/Reports/rptStoreWiseItem2.rpt");
                rptname.Refresh();
                rptname.SetDataSource(dt);
                rptname.SetParameterValue("txtCompName", Session["CompanyName"].ToString());
                rptname.SetParameterValue("txtPeriod", "plant 2 Stock Valuation Report From " + Convert.ToDateTime(From).ToString("dd/MMM/yyyy") + " To " + Convert.ToDateTime(To).ToString("dd/MMM/yyyy"));
                CrystalReportViewer1.ReportSource = rptname;
            }
            else
            {
                PanelMsg.Visible = true;
                lblmsg.Text = "Record Not Found";
                return;
            }
        }

        #endregion
    }
    #endregion

    #region ShowMessage
    public bool ShowMessage(string DiveName, string Message, string MessageType)
    {
        try
        {
            if ((!ClientScript.IsStartupScriptRegistered("regMostrarMensagem")))
            {
                Page.ClientScript.RegisterStartupScript(this.GetType(), "regMostrarMensagem", "MostrarMensagem('" + DiveName + "', '" + Message + "', '" + MessageType + "');", true);
            }
            return true;
        }
        catch (Exception Ex)
        {
            CommonClasses.SendError("Stock Ledger Register", "ShowMessage", Ex.Message);
            return false;
        }
    }
    #endregion

    protected void btnCancel_Click(object sender, EventArgs e)
    {
        try
        {
            Response.Redirect("~/RoportForms/VIEW/ViewStockLedger.aspx", false);
        }
        catch (Exception Ex)
        {
            CommonClasses.SendError("Stock Ledger Register", "btnCancel_Click", Ex.Message);
        }
    }
}
